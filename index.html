<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Metamorphosis</title>
<style>
:root{--fc:rgba(140,160,210,0.75);--fg:rgba(120,140,200,0.3);}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;
  background:radial-gradient(ellipse at 50% 40%,#0d0818 0%,#050210 60%,#010103 100%);
  touch-action:none;user-select:none;-webkit-user-select:none;}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:
    radial-gradient(1px 1px at 12% 18%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 68%  9%,rgba(255,255,255,.38) 0%,transparent 100%),
    radial-gradient(1px 1px at 38% 78%,rgba(255,255,255,.42) 0%,transparent 100%),
    radial-gradient(1px 1px at 83% 52%,rgba(255,255,255,.28) 0%,transparent 100%),
    radial-gradient(1.5px 1.5px at 58% 4%,rgba(255,255,255,.55) 0%,transparent 100%),
    radial-gradient(1.5px 1.5px at 28% 44%,rgba(255,255,255,.42) 0%,transparent 100%),
    radial-gradient(1px 1px at 73% 88%,rgba(255,255,255,.30) 0%,transparent 100%),
    radial-gradient(1px 1px at 6% 62%,rgba(255,255,255,.35) 0%,transparent 100%);}
#flash-overlay{position:fixed;inset:0;z-index:100;pointer-events:none;background:#fff;opacity:0;}
#dark-overlay{position:fixed;inset:0;z-index:2;pointer-events:none;background:#000;opacity:0;}
#edge-aura{position:fixed;inset:0;z-index:9;pointer-events:none;}
#c{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;}
#frame-flow{position:fixed;inset:0;z-index:10;pointer-events:none;}
.gf{fill:none;stroke:var(--fc);stroke-width:1.8;stroke-dasharray:8 280;opacity:0;
  filter:drop-shadow(0 0 2px var(--fc));transition:opacity .5s;}
.gf.on{opacity:.8;animation:gfa 2.4s linear infinite;}
@keyframes gfa{to{stroke-dashoffset:-300;}}
#meteor-svg{position:fixed;inset:0;z-index:8;pointer-events:none;}
.corner{position:fixed;width:60px;height:60px;z-index:10;pointer-events:none;overflow:visible;}
#c-tl{top:0;left:0;}#c-tr{top:0;right:0;}#c-bl{bottom:0;left:0;}#c-br{bottom:0;right:0;}
.corner .cl{fill:none;stroke:var(--fc);stroke-width:1.0;transition:stroke .6s,filter .5s;}
.corner .cl2{fill:none;stroke:var(--fc);stroke-width:0.5;opacity:.5;}
.corner.glow .cl{filter:drop-shadow(0 0 5px var(--fg));}
.edge{position:fixed;z-index:10;pointer-events:none;overflow:visible;}
#e-t{top:0;left:50%;transform:translateX(-50%);width:40px;height:14px;}
#e-b{bottom:0;left:50%;transform:translateX(-50%);width:40px;height:14px;}
#e-l{left:0;top:50%;transform:translateY(-50%);width:14px;height:40px;}
#e-r{right:0;top:50%;transform:translateY(-50%);width:14px;height:40px;}
.edge .el{fill:none;stroke:var(--fc);stroke-width:1.0;transition:stroke .6s;}
.edge .ed{fill:var(--fc);transition:fill .6s;}
#ring{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:120px;height:120px;border-radius:50%;border:1px solid rgba(140,160,210,0.15);
  z-index:11;pointer-events:none;transition:border-color .3s,box-shadow .3s,transform .4s;}
#ring.near{border-color:rgba(212,175,55,.9);
  box-shadow:0 0 24px rgba(212,175,55,.5),0 0 55px rgba(212,175,55,.18);
  transform:translate(-50%,-50%) scale(1.15);}
#align-svg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:190px;height:190px;z-index:12;pointer-events:none;overflow:visible;transition:opacity .5s;}
#reveal-bar{position:fixed;bottom:0;left:0;width:0%;height:4px;z-index:13;
  pointer-events:none;opacity:0;transition:opacity .4s;overflow:hidden;}
#rbar-inner{width:100%;height:100%;position:relative;}
#rbar-fill{width:100%;height:100%;}
#rbar-shine{position:absolute;top:0;left:-80px;width:80px;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.9),transparent);
  animation:barshine 1.1s linear infinite;}
@keyframes barshine{to{left:100vw;}}

/* P3 リゾネート */
#resonate-svg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:300px;height:300px;z-index:12;pointer-events:none;overflow:visible;
  opacity:0;transition:opacity .5s;}

/* TAPテキスト: 初期opacity=0、P3受付開始後にフェードイン */
#tap-flash{
  position:fixed;top:50%;left:50%;transform:translate(-50%,62px);
  z-index:15;pointer-events:none;
  font:14px/1 'Courier New',monospace;letter-spacing:.75em;
  white-space:nowrap;color:rgba(200,230,255,0);
  text-shadow:none;
  transition:color .6s,text-shadow .6s;}
#tap-flash.ready-dark{
  color:rgba(120,160,220,0.3);
  text-shadow:none;}
#tap-flash.ready-glow{
  color:rgba(230,248,255,1);
  text-shadow:0 0 18px rgba(140,210,255,1),0 0 40px rgba(140,200,255,.7),0 0 70px rgba(180,220,255,.4);}

#hold-svg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:200px;height:200px;z-index:12;pointer-events:none;overflow:visible;
  opacity:0;transition:opacity .4s;}
#morse-display{position:fixed;top:50%;left:50%;transform:translate(-50%,66px);
  z-index:13;pointer-events:none;display:flex;gap:8px;align-items:center;
  justify-content:center;min-height:18px;opacity:0;transition:opacity .3s;}
.md{border-radius:4px;background:rgba(255,155,55,.7);box-shadow:0 0 6px rgba(255,155,55,.4);}
.md.s{width:8px;height:8px;border-radius:50%;}
.md.l{width:22px;height:8px;}
.md.lit{background:rgba(255,240,140,.95)!important;box-shadow:0 0 14px rgba(255,220,60,.9)!important;}
#label{position:fixed;bottom:68px;left:50%;transform:translateX(-50%);z-index:12;
  pointer-events:none;font:11px/1 'Courier New',monospace;letter-spacing:.5em;
  color:var(--fc);transition:opacity .6s,color .6s;white-space:nowrap;}
#hint{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);z-index:12;
  pointer-events:none;font:10px/1 'Courier New',monospace;letter-spacing:.3em;
  color:var(--fc);opacity:0;transition:opacity .7s;white-space:nowrap;}
#halo{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:340px;height:340px;border-radius:50%;
  background:radial-gradient(ellipse,rgba(255,150,30,.3) 0%,transparent 60%);
  z-index:9;pointer-events:none;opacity:0;}
#dots{position:fixed;bottom:32px;right:32px;z-index:12;pointer-events:none;display:flex;gap:6px;}
.dot{width:7px;height:7px;border-radius:50%;opacity:.5;}
.dot.cur{width:10px;height:10px;opacity:1;box-shadow:0 0 5px currentColor;}
</style>
</head>
<body>
<div id="flash-overlay"></div>
<div id="dark-overlay"></div>
<div id="edge-aura"></div>
<canvas id="c"></canvas>
<svg id="frame-flow" viewBox="0 0 100 100" preserveAspectRatio="none">
  <path class="gf" id="flow-path" d="M8,50 L8,8 L50,8 L92,8 L92,50 L92,92 L50,92 L8,92 Z"/>
</svg>
<svg id="meteor-svg"></svg>
<svg class="corner" id="c-tl" viewBox="0 0 60 60"><path class="cl" d="M10,48 L10,10 L48,10"/><path class="cl2" d="M10,42 L10,16 L16,10 L42,10"/><line class="cl" x1="10" y1="10" x2="18" y2="18"/></svg>
<svg class="corner" id="c-tr" viewBox="0 0 60 60"><path class="cl" d="M50,48 L50,10 L12,10"/><path class="cl2" d="M50,42 L50,16 L44,10 L18,10"/><line class="cl" x1="50" y1="10" x2="42" y2="18"/></svg>
<svg class="corner" id="c-bl" viewBox="0 0 60 60"><path class="cl" d="M10,12 L10,50 L48,50"/><path class="cl2" d="M10,18 L10,44 L16,50 L42,50"/><line class="cl" x1="10" y1="50" x2="18" y2="42"/></svg>
<svg class="corner" id="c-br" viewBox="0 0 60 60"><path class="cl" d="M50,12 L50,50 L12,50"/><path class="cl2" d="M50,18 L50,44 L44,50 L18,50"/><line class="cl" x1="50" y1="50" x2="42" y2="42"/></svg>
<svg class="edge" id="e-t" viewBox="0 0 40 14"><line class="el" x1="0" y1="1" x2="14" y2="1"/><line class="el" x1="26" y1="1" x2="40" y2="1"/><polygon class="ed" points="20,1 22.2,5 20,9 17.8,5"/></svg>
<svg class="edge" id="e-b" viewBox="0 0 40 14"><line class="el" x1="0" y1="13" x2="14" y2="13"/><line class="el" x1="26" y1="13" x2="40" y2="13"/><polygon class="ed" points="20,13 22.2,9 20,5 17.8,9"/></svg>
<svg class="edge" id="e-l" viewBox="0 0 14 40"><line class="el" x1="1" y1="0" x2="1" y2="14"/><line class="el" x1="1" y1="26" x2="1" y2="40"/><polygon class="ed" points="1,20 5,17.8 9,20 5,22.2"/></svg>
<svg class="edge" id="e-r" viewBox="0 0 14 40"><line class="el" x1="13" y1="0" x2="13" y2="14"/><line class="el" x1="13" y1="26" x2="13" y2="40"/><polygon class="ed" points="13,20 9,17.8 5,20 9,22.2"/></svg>
<svg id="align-svg" viewBox="0 0 190 190">
  <circle cx="95" cy="95" r="80" fill="none" stroke="rgba(140,160,210,0.07)" stroke-width="1.5"/>
  <circle id="align-arc" cx="95" cy="95" r="80" fill="none" stroke="rgba(140,160,210,0.7)"
    stroke-width="2.8" stroke-linecap="round" stroke-dasharray="503" stroke-dashoffset="503" transform="rotate(-90 95 95)"/>
  <path id="aa-t" d="M95,5 L89,16 L101,16 Z"    fill="rgba(140,160,210,0.28)"/>
  <path id="aa-b" d="M95,185 L89,174 L101,174 Z" fill="rgba(140,160,210,0.28)"/>
  <path id="aa-l" d="M5,95 L16,89 L16,101 Z"    fill="rgba(140,160,210,0.28)"/>
  <path id="aa-r" d="M185,95 L174,89 L174,101 Z" fill="rgba(140,160,210,0.28)"/>
</svg>
<svg id="resonate-svg" viewBox="0 0 300 300">
  <circle id="res-ring"    cx="150" cy="150" r="62" fill="none" stroke="rgba(80,130,220,0.20)" stroke-width="1.2"/>
  <circle id="res-outer"   cx="150" cy="150" r="80" fill="none" stroke="rgba(80,130,220,0.08)" stroke-width="1"/>
  <circle id="res-ripple"  cx="150" cy="150" r="62" fill="none" stroke="rgba(180,220,255,0)"   stroke-width="4"/>
  <circle id="res-ripple2" cx="150" cy="150" r="62" fill="none" stroke="rgba(255,255,255,0)"   stroke-width="2"/>
</svg>
<div id="tap-flash">T A P</div>
<svg id="hold-svg" viewBox="0 0 200 200">
  <circle cx="100" cy="100" r="86" fill="none" stroke="rgba(180,40,20,0.08)" stroke-width="3"/>
  <circle id="hold-arc" cx="100" cy="100" r="86" fill="none"
    stroke="rgba(200,30,30,0.90)" stroke-width="4.5" stroke-linecap="round"
    stroke-dasharray="541" stroke-dashoffset="541" transform="rotate(-90 100 100)"/>
</svg>
<div id="morse-display"></div>
<div id="ring"></div>
<div id="label">↻&nbsp;&nbsp;C H A O S</div>
<div id="hint"></div>
<div id="halo"></div>
<div id="reveal-bar"><div id="rbar-inner"><div id="rbar-fill"></div><div id="rbar-shine"></div></div></div>
<div id="dots"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const TAU=Math.PI*2;
const W=()=>window.innerWidth,H=()=>window.innerHeight;
const rnd=(a,b)=>a+(b-a)*Math.random();
const lerp=(a,b,t)=>a+(b-a)*t;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ─── renderer ─── */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(50,W()/H(),.1,100);
camera.position.z=12;
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(W(),H());
renderer.outputEncoding=THREE.sRGBEncoding;
window.addEventListener('resize',()=>{camera.aspect=W()/H();camera.updateProjectionMatrix();renderer.setSize(W(),H());});

scene.add(new THREE.AmbientLight(0x112244,2.5));
const dL=new THREE.DirectionalLight(0xffffff,4.5);dL.position.set(4,8,6);scene.add(dL);
const rL=new THREE.DirectionalLight(0x6633cc,2.5);rL.position.set(-4,-2,-4);scene.add(rL);
const pL =new THREE.PointLight(0xffffff,1.5,30);scene.add(pL);
const pL2=new THREE.PointLight(0x88aaff,0,18);pL2.position.set(-2,3,5);scene.add(pL2);

/* ─── DOM ─── */
const flashOv  =document.getElementById('flash-overlay');
const darkOv   =document.getElementById('dark-overlay');
const edgeAura =document.getElementById('edge-aura');
const corners  =[...document.querySelectorAll('.corner')];
const flowEl   =document.getElementById('flow-path');
const ringEl   =document.getElementById('ring');
const labelEl  =document.getElementById('label');
const hintEl   =document.getElementById('hint');
const haloEl   =document.getElementById('halo');
const dotsEl   =document.getElementById('dots');
const alignSvg =document.getElementById('align-svg');
const alignArc =document.getElementById('align-arc');
const aaArrows =['aa-t','aa-b','aa-l','aa-r'].map(id=>document.getElementById(id));
const revealBar=document.getElementById('reveal-bar');
const rbarFill =document.getElementById('rbar-fill');
const resonSvg =document.getElementById('resonate-svg');
const resRing  =document.getElementById('res-ring');
const resOuter =document.getElementById('res-outer');
const resRipple=document.getElementById('res-ripple');
const resRip2  =document.getElementById('res-ripple2');
const tapEl    =document.getElementById('tap-flash');
const holdSvg  =document.getElementById('hold-svg');
const holdArc  =document.getElementById('hold-arc');
const morseEl  =document.getElementById('morse-display');
const meteorSvg=document.getElementById('meteor-svg');

/* ─── helpers ─── */
const doFlash=(op=.85,hold=80,fade=500,col='#fff')=>{
  flashOv.style.background=col;
  flashOv.style.transition='opacity 0s';
  flashOv.style.opacity=String(op);
  setTimeout(()=>{flashOv.style.transition=`opacity ${fade}ms`;flashOv.style.opacity='0';
    setTimeout(()=>{flashOv.style.background='#fff';},fade+50);},hold);
};

const applyPhase=p=>{
  const fc={1:'rgba(140,160,210,0.75)',2:'rgba(212,175,55,0.85)',
            3:'rgba(100,190,255,0.80)',4:'rgba(255,130,40,0.90)',5:'rgba(200,210,230,0.60)'}[p];
  document.documentElement.style.setProperty('--fc',fc);
  corners.forEach(el=>el.classList.toggle('glow',p>=2));
  flowEl.classList.toggle('on',p===1);
  alignSvg.style.opacity   = p===1?'1':'0';
  revealBar.style.opacity  = p===2?'1':'0';
  resonSvg.style.opacity   = p===3?'1':'0';
  holdSvg.style.opacity    = p===4?'1':'0';
  morseEl.style.opacity    = p===4?'1':'0';
  labelEl.style.opacity    = (p>=1&&p<=3)?'1':'0';
  labelEl.textContent      ={1:'↻\u00a0\u00a0C H A O S',2:'≋\u00a0\u00a0R E V E A L',3:'◎\u00a0\u00a0R E S O N A T E'}[p]||'';
  haloEl.style.opacity='0';
  edgeAura.style.boxShadow='none';
  // tapElは P3専用・個別管理
  tapEl.style.opacity = p===3?'':'0';
  if(p!==3){tapEl.className='';tapEl.style.opacity='0';}
};

/* ─── materials ─── */
const coreMat=new THREE.MeshPhongMaterial({
  color:0x7755dd,emissive:0x110022,specular:0xffffff,shininess:80,flatShading:true});
const shardMat=new THREE.MeshPhongMaterial({
  color:0xaaddff,emissive:0x001122,specular:0xffffff,shininess:240,
  flatShading:true,transparent:true,opacity:.84,side:THREE.DoubleSide});

/* ─── shard geometry ─── */
const buildShardGeo=()=>{
  const h=rnd(.7,1.6),r=rnd(.12,.30);
  const s=new THREE.Shape();
  s.moveTo(0,0);s.lineTo(r+rnd(-.06,.12),h*rnd(.68,.88));s.lineTo(-r+rnd(-.10,.06),h+rnd(-.04,.10));s.closePath();
  const g=new THREE.ExtrudeGeometry(s,{depth:.04,bevelEnabled:false});
  g.computeVertexNormals();return g;
};
const SHARD_GEOS=Array.from({length:8},buildShardGeo);
const MAX_S=120;
const shards=new THREE.InstancedMesh(SHARD_GEOS[0],shardMat,MAX_S);
shards.count=0;scene.add(shards);
const shardInfo=[];

/* ─── particles ─── */
const PC=240;
const pPA=new Float32Array(PC*3);
const pPV=Array.from({length:PC},()=>new THREE.Vector3());
const pPG=new THREE.BufferGeometry();
pPG.setAttribute('position',new THREE.BufferAttribute(pPA,3));
const pPM=new THREE.PointsMaterial({size:.09,color:0xffcc44,transparent:true,opacity:0,
  blending:THREE.AdditiveBlending,depthWrite:false});
scene.add(new THREE.Points(pPG,pPM));

/* ─── lerp targets (ぬるぬる管理) ─── */
const LT={
  camZ:12,
  coreScale:1,
  pLIntensity:1.5,
  ringR:62,
  darkOvOp:0,
  flashOvOp:0,
  haloOp:0,
  haloScale:1,
  edgeGlow:0,
};
const LC={  // 現在値
  camZ:12,coreScale:1,pLIntensity:1.5,ringR:62,
  darkOvOp:0,flashOvOp:0,haloOp:0,haloScale:1,edgeGlow:0,
};

/* ─── state ─── */
const S={
  phase:1,polish:0,energy:0,
  holding:false,dragging:false,
  demoOn:true,demoVx:.008,demoVy:.005,
  rot:0,hue:.68,petalHue:.72,
  p5Start:0,prevX:0,prevY:0,pdTime:0,lastInteract:0,
  // P3
  beatPhase:0,
  isLight:false,        // 現在光るゾーンか
  introCount:0,         // 光るゾーンを何回経験したか
  tapReady:false,       // タップ受付開始か
  rippleT:-1,rip2T:-1,
  // P4
  arcOffset:541,        // lerp用
  tapHistory:[],
  shakeAmt:0,
  p5CamStart:12,
};
const UP=new THREE.Vector3(0,1,0),RIGHT=new THREE.Vector3(1,0,0),FWD=new THREE.Vector3(0,0,1);
const IQ=new THREE.Quaternion();
const SNAP=Math.cos(.05),NEAR=Math.cos(.30);
let coreObj=null,basePosArr=null,faceDistort=null,arrowT=0,hintShown=false;
let fragmentMeshes=[];
const GEN_HUES=[];
let meteorTimer=0;

const renderMorse=()=>{
  morseEl.innerHTML='';
  const recent=S.tapHistory.slice(-4);
  recent.forEach(tap=>{
    const el=document.createElement('div');
    el.className='md '+(tap.type==='short'?'s':'l');
    if(JSON.stringify(recent.slice(-3).map(t=>t.type))===JSON.stringify(['short','long','short'])) el.classList.add('lit');
    morseEl.appendChild(el);
  });
};

const buildFragments=()=>{
  fragmentMeshes.forEach(m=>{scene.remove(m);m.geometry.dispose();m.material.dispose();});
  fragmentMeshes=[];
  if(!coreObj) return;
  const sp=coreObj.geometry.attributes.position;
  for(let f=0;f<Math.floor(sp.count/3);f++){
    const i=f*3;
    const ax=sp.getX(i),ay=sp.getY(i),az=sp.getZ(i);
    const bx=sp.getX(i+1),by=sp.getY(i+1),bz=sp.getZ(i+1);
    const cx=sp.getX(i+2),cy=sp.getY(i+2),cz=sp.getZ(i+2);
    const g=new THREE.BufferGeometry();
    g.setAttribute('position',new THREE.BufferAttribute(new Float32Array([ax,ay,az,bx,by,bz,cx,cy,cz]),3));
    g.computeVertexNormals();
    const mat=new THREE.MeshPhongMaterial({color:coreMat.color.clone(),
      emissive:new THREE.Color(.3,.5,1).multiplyScalar(.35),
      specular:new THREE.Color(1,1,1),shininess:200,flatShading:true,transparent:true,opacity:1});
    const mesh=new THREE.Mesh(g,mat);
    mesh.position.copy(coreObj.position);mesh.quaternion.copy(coreObj.quaternion);
    const center=new THREE.Vector3((ax+bx+cx)/3,(ay+by+cy)/3,(az+bz+cz)/3).applyQuaternion(coreObj.quaternion);
    mesh.userData.vel=center.normalize().multiplyScalar(.06+rnd(0,.08));
    mesh.userData.vel.y+=.022+rnd(0,.028);
    mesh.userData.angVel=new THREE.Vector3(rnd(-.22,.22),rnd(-.22,.22),rnd(-.22,.22));
    scene.add(mesh);fragmentMeshes.push(mesh);
  }
};

const triggerBloom=energy=>{
  shardInfo.length=0;
  const cnt=Math.floor(energy*MAX_S);
  for(let i=0;i<cnt;i++){
    const phi=Math.acos(rnd(-1,1)),th=rnd(0,TAU);
    const fp=new THREE.Vector3().setFromSphericalCoords(2.2,phi,th);
    const sp=fp.clone().normalize().multiplyScalar(10);
    const d=new THREE.Object3D();
    d.position.copy(fp);d.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),fp.clone().normalize());
    d.rotateY(rnd(0,TAU));d.rotateX(rnd(-1,1));d.scale.setScalar(rnd(.06,.14));d.updateMatrix();
    shardInfo.push({fp,sp,mat:d.matrix.clone(),d,delay:i*.014,landed:false});
  }
  shards.count=shardInfo.length;
  shardMat.color.setHSL(S.petalHue,.9,.65);shardMat.emissive.setHSL(S.petalHue,1,.22);
  S.p5Start=clock.getElapsedTime();S.p5CamStart=camera.position.z;
  buildFragments();applyPhase(5);S.phase=5;
  pPM.color.setHSL(S.petalHue,1,.85);burstParticles();
  LT.pLIntensity=18*energy;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=5;
  doFlash(1.0,120,900);
  setTimeout(()=>{renderer.domElement.style.transition='opacity 3s';renderer.domElement.style.opacity='0';},5000);
  setTimeout(()=>spawn(true),8000);
};

/* ─── P3突入 ─── */
const enterP3=()=>{
  // 状態クリア
  if(faceDistort) faceDistort.fill(0);
  const pos=coreObj.geometry.attributes.position;
  for(let i=0;i<pos.count;i++) pos.setXYZ(i,basePosArr[i*3],basePosArr[i*3+1],basePosArr[i*3+2]);
  pos.needsUpdate=true;coreObj.geometry.computeVertexNormals();
  pPM.opacity=0;
  // P3初期: 暗いコア
  coreMat.color.setHSL(S.petalHue,.7,.22);
  coreMat.emissive.setHSL(S.petalHue,.8,.01);
  coreMat.shininess=120;coreMat.needsUpdate=true;
  LC.coreScale=S.phase===2?coreObj.scale.x:1;
  coreObj.scale.setScalar(LC.coreScale);
  // beatPhaseをリセット: 暗いゾーン（-π/2付近）からスタート
  // sin(-π/2)=-1 → 約0.7秒後にsin=0を超えて最初の光るゾーンへ
  S.beatPhase=Math.PI*1.5;
  S.isLight=false;S.introCount=0;S.tapReady=false;
  S.rippleT=-1;S.rip2T=-1;
  LT.ringR=62;LT.camZ=13.5;LT.darkOvOp=0.12;
  tapEl.className='';tapEl.style.opacity='0';
  hintEl.style.opacity='0';
  applyPhase(3);S.phase=3;
};

/* ─── spawn ─── */
const spawn=(fade=false)=>{
  const go=()=>{
    S.hue=Math.random();S.petalHue=(S.hue+.12)%1;GEN_HUES.push(S.hue);
    if(coreObj){scene.remove(coreObj);coreObj.geometry.dispose();}
    fragmentMeshes.forEach(m=>{scene.remove(m);m.geometry.dispose();m.material.dispose();});
    fragmentMeshes=[];
    const detail=[1,2,2,3][Math.floor(Math.random()*4)];
    const geo=new THREE.IcosahedronGeometry(2.2,detail);geo.computeVertexNormals();
    basePosArr=new Float32Array(geo.attributes.position.array);
    faceDistort=new Float32Array(Math.floor(geo.attributes.position.count/3));
    coreMat.color.setHSL(S.hue,.7,.42);coreMat.emissive.setHSL(S.hue,.9,.04);
    coreMat.shininess=80;coreMat.transparent=false;coreMat.opacity=1;coreMat.needsUpdate=true;
    shardMat.color.setHSL(S.petalHue,.9,.65);shardMat.emissive.setHSL(S.petalHue,1,.12);
    pL.color.setHSL(S.petalHue,1,.5);rL.color.setHSL((S.hue+.5)%1,.7,.4);
    coreObj=new THREE.Mesh(geo,coreMat);
    coreObj.rotation.set(rnd(0,TAU),rnd(0,TAU),rnd(0,TAU));scene.add(coreObj);
    S.phase=1;S.polish=0;S.energy=0;S.holding=false;S.dragging=false;
    S.demoOn=true;S.demoVx=.008;S.demoVy=.005;S.rot=0;
    S.lastInteract=0;S.beatPhase=0;S.isLight=false;S.introCount=0;S.tapReady=false;
    S.rippleT=-1;S.rip2T=-1;S.tapHistory=[];S.shakeAmt=0;
    shards.count=0;shardInfo.length=0;pPM.opacity=0;pL2.intensity=0;
    coreObj.scale.set(1,1,1);coreObj.position.set(0,0,0);
    shards.scale.set(1,1,1);shards.position.set(0,0,0);
    alignArc.setAttribute('stroke-dashoffset','503');
    revealBar.style.width='0%';S.arcOffset=541;
    holdArc.setAttribute('stroke-dashoffset','541');holdArc.style.opacity='1';
    holdArc.setAttribute('stroke','rgba(200,30,30,0.90)');holdArc.style.filter='';
    morseEl.innerHTML='';ringEl.classList.remove('near');hintEl.style.opacity='0';
    tapEl.className='';tapEl.style.opacity='0';
    Object.assign(LT,{camZ:12,coreScale:1,pLIntensity:1.5,ringR:62,
      darkOvOp:0,flashOvOp:0,haloOp:0,haloScale:1,edgeGlow:0});
    Object.assign(LC,{camZ:12,coreScale:1,pLIntensity:1.5,ringR:62,
      darkOvOp:0,flashOvOp:0,haloOp:0,haloScale:1,edgeGlow:0});
    renderer.toneMapping=THREE.NoToneMapping;renderer.toneMappingExposure=1;
    renderer.domElement.style.transition='opacity .5s';renderer.domElement.style.opacity='1';
    document.body.style.transform='';document.body.style.background='radial-gradient(ellipse at 50% 40%,#0d0818 0%,#050210 60%,#010103 100%)';
    applyPhase(1);
    dotsEl.innerHTML='';
    GEN_HUES.slice(-8).forEach((h,i,a)=>{
      const d=document.createElement('div');d.className='dot'+(i===a.length-1?' cur':'');
      d.style.background=`hsl(${Math.round(h*360)},80%,60%)`;d.style.color=d.style.background;
      dotsEl.appendChild(d);
    });
    if(!hintShown){hintShown=true;hintEl.textContent='drag to align';hintEl.style.opacity='.6';
      setTimeout(()=>{if(S.phase===1)hintEl.style.opacity='0';},3500);}
  };
  if(fade) setTimeout(go,80);else go();
};
spawn(false);

const burstParticles=()=>{
  for(let i=0;i<PC;i++){
    pPA[i*3]=rnd(-3,3);pPA[i*3+1]=rnd(-3,3);pPA[i*3+2]=rnd(-3,3);
    const d=new THREE.Vector3(pPA[i*3],pPA[i*3+1],pPA[i*3+2]).normalize();
    pPV[i].copy(d.multiplyScalar(.03+rnd(0,.05)));
  }
  pPG.attributes.position.needsUpdate=true;pPM.opacity=.9;
};

const spawnMeteor=()=>{
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  const sx=rnd(5,88),sy=rnd(3,35),len=rnd(6,16),ang=rnd(.3,.65);
  line.setAttribute('x1',sx+'%');line.setAttribute('y1',sy+'%');
  line.setAttribute('x2',(sx+len*Math.cos(ang))+'%');line.setAttribute('y2',(sy+len*Math.sin(ang))+'%');
  line.setAttribute('stroke','rgba(210,228,255,0.72)');line.setAttribute('stroke-width','0.5');
  line.style.transition='opacity .35s';
  meteorSvg.appendChild(line);
  setTimeout(()=>{line.style.opacity='0';setTimeout(()=>{try{meteorSvg.removeChild(line);}catch(e){}},400);},110);
};

/* ─── input ─── */
const gc=e=>e.touches?e.touches[0]:e;
renderer.domElement.addEventListener('pointerdown',e=>{
  if(e.touches&&e.touches.length>1)return;
  const c=gc(e);S.prevX=c.clientX;S.prevY=c.clientY;
  S.dragging=true;S.demoOn=false;S.pdTime=performance.now();
  S.lastInteract=clock.getElapsedTime();
  if(S.phase===4) S.holding=true;
},{passive:true});

renderer.domElement.addEventListener('pointermove',e=>{
  if(!S.dragging)return;
  const c=gc(e);const dx=c.clientX-S.prevX,dy=c.clientY-S.prevY;
  S.prevX=c.clientX;S.prevY=c.clientY;S.lastInteract=clock.getElapsedTime();
  if(S.phase===1){
    const lf=FWD.clone().applyQuaternion(coreObj.quaternion.clone().invert());
    const al=lf.dot(FWD);
    if(al>NEAR){
      ringEl.classList.add('near');
      coreObj.quaternion.slerp(IQ,.16);
      const a2=FWD.clone().applyQuaternion(coreObj.quaternion.clone().invert()).dot(FWD);
      if(a2>SNAP){
        coreObj.quaternion.copy(IQ);coreObj.rotation.setFromQuaternion(IQ);
        S.rot=coreObj.rotation.y;ringEl.classList.remove('near');
        coreMat.color.setHSL(S.hue,.55,.08);coreMat.emissive.setHSL(S.hue,.8,.01);
        coreMat.shininess=20;coreMat.needsUpdate=true;
        LT.camZ=9.5;setTimeout(()=>LT.camZ=12,700);
        doFlash(.38,50,400);applyPhase(2);S.phase=2;
        hintEl.textContent='rub to reveal';hintEl.style.opacity='.6';
        setTimeout(()=>{if(S.phase===2)hintEl.style.opacity='0';},2800);
      }
    } else {
      ringEl.classList.remove('near');
      const prx=Math.max(0,(al+1)/2);
      coreObj.quaternion
        .premultiply(new THREE.Quaternion().setFromAxisAngle(UP,   dx*.007*(1-prx*.7)))
        .premultiply(new THREE.Quaternion().setFromAxisAngle(RIGHT,dy*.007*(1-prx*.7)));
    }
  } else if(S.phase===2){
    const fr=Math.abs(dx)+Math.abs(dy);
    S.polish=Math.min(1,S.polish+fr*.00013);
    const p=S.polish;
    const bH=p<.4?`hsl(0,85%,${14+p*28}%)`
             :p<.75?`hsl(${p*30},95%,${25+p*32}%)`
             :`hsl(${40+p*18},100%,${48+p*34}%)`;
    rbarFill.style.background=`linear-gradient(90deg,${bH},hsl(${50+p*12},100%,${62+p*28}%))`;
    revealBar.style.width=(p*100)+'%';
    coreMat.color.setHSL((S.hue+p*.06)%1,.6+p*.35,.07+p*.65);
    coreMat.emissive.setHSL(p<.5?0:S.hue+p*.04,.95,p<.3?p*.07:.02+p*.26);
    coreMat.shininess=20+p*320;
    if(fr>4&&faceDistort){
      const ns=Math.min(7,Math.floor(fr*.35));
      for(let k=0;k<ns;k++){const fi=Math.floor(Math.random()*faceDistort.length);faceDistort[fi]=Math.min(.58,(1-p)*.5+rnd(0,.28));}
      if(fr>14&&Math.random()<.3){pL2.intensity=5;}
    }
    if(fr>5){
      pPM.color.setHSL((S.hue+p*.1)%1,.9,.72);pPM.opacity=Math.min(.65,fr*.032);
      const wx=(S.prevX/W()*2-1)*6,wy=-(S.prevY/H()*2-1)*6;
      for(let i=0;i<Math.min(8,Math.floor(fr*.4));i++){
        const idx=Math.floor(rnd(0,PC))*3;
        pPA[idx]=wx+rnd(-.7,.7);pPA[idx+1]=wy+rnd(-.7,.7);pPA[idx+2]=1+Math.random();
        pPV[idx/3].set(rnd(-.14,.14),rnd(0,.17),rnd(0,.09));
      }
      pPG.attributes.position.needsUpdate=true;
      if(navigator.vibrate) navigator.vibrate(1);
    }
  }
},{passive:true});

window.addEventListener('pointerup',()=>{
  if(!S.dragging)return;S.dragging=false;
  const dur=performance.now()-S.pdTime;

  /* ── P3 TAP ── */
  if(S.phase===3){
    if(!S.tapReady) return; // 導入中はタップ無効
    if(S.isLight){
      // 成功
      S.rippleT=0;S.rip2T=0.12;
      doFlash(.75,70,700);
      coreMat.emissive.setHSL(0,0,1.2);LT.pLIntensity=40;
      if(navigator.vibrate) navigator.vibrate([30,10,30]);
      setTimeout(()=>{
        if(S.phase!==3)return;
        S.energy=.50;S.phase=4;applyPhase(4);
        S.arcOffset=541*(1-.50);
        holdArc.setAttribute('stroke-dashoffset',String(S.arcOffset.toFixed(1)));
        hintEl.textContent='hold \u00a0or\u00a0 · — ·';hintEl.style.opacity='.6';
        setTimeout(()=>{if(S.phase===4)hintEl.style.opacity='0';},3200);
      },350);
    } else {
      // ミス
      doFlash(.28,60,380,'rgba(255,20,0,1)');
      pL2.color.set(0xff2200);pL2.intensity=6;
      coreMat.emissive.setHSL(0,.95,.30);
      setTimeout(()=>{if(S.phase===3)coreMat.emissive.setHSL(S.petalHue,.8,.01);},400);
      if(navigator.vibrate) navigator.vibrate(65);
    }
    return;
  }

  /* ── P4 ── */
  if(S.phase===4){
    S.holding=false;
    const tapType=dur<300?'short':'long';
    S.tapHistory.push({type:tapType,t:Date.now()});
    while(S.tapHistory.length>0&&Date.now()-S.tapHistory[0].t>2500) S.tapHistory.shift();
    renderMorse();
    const last3=S.tapHistory.slice(-3).map(t=>t.type);
    if(JSON.stringify(last3)===JSON.stringify(['short','long','short'])){triggerBloom(1.0);S.tapHistory=[];}
    else if(tapType==='long'&&dur>400){
      if(S.energy>.25) triggerBloom(S.energy);
      else{S.arcOffset=541;S.energy=0;}
    } else {
      S.energy=Math.min(1,S.energy+.12);
      if(JSON.stringify(S.tapHistory.slice(-3).map(t=>t.type))==='["short","short","short"]'){triggerBloom(.45);S.tapHistory=[];}
    }
    if(S.phase===4){coreObj.scale.set(1,1,1);coreObj.position.set(0,0,0);}
  }
});
document.addEventListener('contextmenu',e=>e.preventDefault());

/* ─── main loop ─── */
const clock=new THREE.Clock();
const EQ=t=>t*t*t*t;

function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime();
  const dt=Math.min(clock.getDelta(),.05);

  /* ── lerp: 全体ぬるぬる ── */
  // pL2は常時減衰（バグ修正）
  pL2.intensity=lerp(pL2.intensity,0,.12);

  // camera
  const camBreath=(S.phase<=3)?Math.sin(t*.48)*.28:0;
  LC.camZ=lerp(LC.camZ,LT.camZ+camBreath,.04); // ゆっくり追従
  camera.position.z=LC.camZ;

  // pL intensity
  LC.pLIntensity=lerp(LC.pLIntensity,LT.pLIntensity,.07);
  pL.intensity=LC.pLIntensity;

  // dark/flash overlay
  LC.darkOvOp=lerp(LC.darkOvOp,LT.darkOvOp,.12);
  darkOv.style.opacity=LC.darkOvOp.toFixed(3);

  // halo
  LC.haloOp=lerp(LC.haloOp,LT.haloOp,.10);
  LC.haloScale=lerp(LC.haloScale,LT.haloScale,.08);
  haloEl.style.opacity=LC.haloOp.toFixed(3);
  haloEl.style.transform=`translate(-50%,-50%) scale(${LC.haloScale.toFixed(3)})`;

  // core scale
  LC.coreScale=lerp(LC.coreScale,LT.coreScale, S.phase===3&&S.isLight?.15:.08);
  coreObj&&coreObj.scale.setScalar(LC.coreScale);

  // ring radius
  LC.ringR=lerp(LC.ringR,LT.ringR, S.phase===3&&S.isLight?.16:.06);
  if(S.phase===3){
    resRing.setAttribute('r',LC.ringR.toFixed(1));
    resOuter.setAttribute('r',(LC.ringR+16).toFixed(1));
  }

  // edge glow
  LC.edgeGlow=lerp(LC.edgeGlow,LT.edgeGlow,.08);
  if(LC.edgeGlow>1) edgeAura.style.boxShadow=`inset 0 0 ${Math.round(LC.edgeGlow)}px rgba(255,180,50,${(LC.edgeGlow/120).toFixed(3)})`;

  // shake
  if(S.shakeAmt>.05){
    document.body.style.transform=`translate(${rnd(-S.shakeAmt,S.shakeAmt)}px,${rnd(-S.shakeAmt,S.shakeAmt)}px)`;
    S.shakeAmt*=.87;
  } else if(S.shakeAmt>0){S.shakeAmt=0;document.body.style.transform='';}

  // 流星
  if(S.phase===1){meteorTimer+=dt;if(meteorTimer>2.0+rnd(0,1.8)){meteorTimer=0;spawnMeteor();}}

  /* ━━ P1 ━━ */
  if(S.phase===1){
    if(!S.demoOn&&(t-S.lastInteract)>6){S.demoOn=true;S.demoVy=.004;S.demoVx=.003;}
    if(S.demoOn){
      coreObj.quaternion.premultiply(new THREE.Quaternion().setFromAxisAngle(UP,S.demoVy))
                        .premultiply(new THREE.Quaternion().setFromAxisAngle(RIGHT,S.demoVx));
      S.demoVy*=.996;S.demoVx*=.996;
    }
    const pos=coreObj.geometry.attributes.position;
    const breath=.19+Math.sin(t*.50)*.055;
    for(let i=0;i<pos.count;i++){
      const bx=basePosArr[i*3],by=basePosArr[i*3+1],bz=basePosArr[i*3+2];
      const n=Math.sin(bx*4+t*1.5)*Math.cos(by*4+t*1.2)*Math.sin(bz*4+t*1.4);
      pos.setXYZ(i,bx*(1+n*breath),by*(1+n*breath),bz*(1+n*breath));
    }
    pos.needsUpdate=true;coreObj.geometry.computeVertexNormals();
    const al=FWD.clone().applyQuaternion(coreObj.quaternion.clone().invert()).dot(FWD);
    const res=clamp((al-.3)/.7,0,1);
    coreMat.color.setHSL((S.hue+res*.10)%1,.70+res*.22,.26+res*.30);
    coreMat.emissive.setHSL(S.hue,1,.02+Math.sin(t*1.3)*.02+res*.22);
    LT.coreScale=.97+Math.sin(t*.48)*.03; // 呼吸
    LT.pLIntensity=1.2+res*3;
    LT.camZ=12-res*1.2; // 近づくにつれカメラも寄る
    ringEl.classList.toggle('near',al>NEAR);
    const arcFill=clamp((al+1)/2,0,1);
    alignArc.setAttribute('stroke-dashoffset',String((503*(1-arcFill)).toFixed(1)));
    const gr=Math.round(140+res*72),gg=Math.round(160+res*15),gb=Math.round(210-res*155);
    alignArc.setAttribute('stroke',`rgba(${gr},${gg},${gb},${(.38+res*.62).toFixed(2)})`);
    arrowT=(arrowT+dt*2)%TAU;
    aaArrows.forEach((a,i)=>a.setAttribute('fill',`rgba(140,160,210,${(0.14+Math.sin(arrowT+(i<2?0:1.5))*.13).toFixed(2)})`));
  }

  /* ━━ P2 ━━ */
  else if(S.phase===2){
    const idle=t-S.lastInteract;
    if(idle>4.5) revealBar.style.boxShadow=`0 0 ${6+Math.sin(t*3.5)*6}px rgba(212,175,55,${.28+Math.sin(t*3.5)*.28})`;
    const pos=coreObj.geometry.attributes.position;
    const fc=faceDistort?faceDistort.length:0;
    for(let i=0;i<pos.count;i++){
      const bx=basePosArr[i*3],by=basePosArr[i*3+1],bz=basePosArr[i*3+2];
      const n=Math.sin(bx*4+t*2.8)*Math.cos(by*4+t*2.0)*Math.sin(bz*4+t*2.3)*.18*(1-S.polish);
      const spk=faceDistort&&Math.floor(i/3)<fc?faceDistort[Math.floor(i/3)]:0;
      pos.setXYZ(i,bx*(1+n+spk),by*(1+n+spk),bz*(1+n+spk));
    }
    pos.needsUpdate=true;coreObj.geometry.computeVertexNormals();
    if(faceDistort) for(let fi=0;fi<faceDistort.length;fi++) faceDistort[fi]*=.84;
    coreObj.rotation.y=t*.16+S.rot;
    if(pPM.opacity>0){
      pPM.opacity=Math.max(0,pPM.opacity-.016);
      for(let i=0;i<PC;i++){pPA[i*3]+=pPV[i].x;pPA[i*3+1]+=pPV[i].y;pPA[i*3+2]+=pPV[i].z;pPV[i].y-=.007;}
      pPG.attributes.position.needsUpdate=true;
    }
    if(S.polish>=1){
      S.rot=coreObj.rotation.y-t*.18;
      doFlash(.52,90,550);LT.camZ=9;setTimeout(()=>{LT.camZ=12;},950);
      enterP3();
    }
  }

  /* ━━ P3 RESONATE (完全再設計) ━━ */
  else if(S.phase===3){
    // 周期: 約1.4s
    S.beatPhase=(S.beatPhase+dt*TAU*.72)%(TAU);
    const sinV=Math.sin(S.beatPhase);
    const nowLight=sinV>0;

    // ゾーン切替検出
    if(nowLight!==S.isLight){
      S.isLight=nowLight;
      if(nowLight){
        // 暗 → 光: パンチ感のある立ち上がり
        S.introCount++;
        LT.coreScale=1.22;LT.pLIntensity=35;LT.camZ=10;
        LT.ringR=130;LT.darkOvOp=0;
        if(navigator.vibrate) navigator.vibrate(8); // haptic でリズム感
        // 3回目から受付開始: TAPフェードイン
        if(S.introCount>=3&&!S.tapReady){
          S.tapReady=true;
          tapEl.style.opacity='1';tapEl.className='ready-dark';
        }
        if(S.tapReady){tapEl.className='ready-glow';}
      } else {
        // 光 → 暗: 余韻を持たせた減衰
        LT.coreScale=0.88;LT.pLIntensity=0.4;LT.camZ=13.5;
        LT.ringR=62;LT.darkOvOp=0.13;
        if(S.tapReady){tapEl.className='ready-dark';}
      }
    }

    // 毎フレーム: コアの色をlerpターゲットとsinに連動
    if(S.isLight){
      const s=clamp(sinV,0,1);
      coreMat.color.setHSL(S.petalHue-.03,.55,.52+s*.42);
      coreMat.emissive.setHSL(lerp(S.petalHue,0,s*.8),lerp(1,0,s*.8),s*.95);
      coreMat.shininess=120+s*280;
      resRing.setAttribute('stroke',`rgba(200,235,255,${(.3+s*.65).toFixed(2)})`);
      resRing.setAttribute('stroke-width',(1.5+s*2.8).toFixed(1));
      resOuter.setAttribute('stroke',`rgba(150,200,255,${(s*.32).toFixed(2)})`);
    } else {
      const s=clamp(-sinV,0,1);
      coreMat.color.setHSL(S.petalHue,.7,.18+s*.05);
      coreMat.emissive.setHSL(S.petalHue,.8,.008);
      coreMat.shininess=80;
      resRing.setAttribute('stroke',`rgba(70,120,200,${(.10+s*.05).toFixed(2)})`);
      resRing.setAttribute('stroke-width','1');
      resOuter.setAttribute('stroke','rgba(50,90,160,0.05)');
    }
    coreObj.rotation.y=t*.12+S.rot;

    // 波紋
    if(S.rippleT>=0){
      S.rippleT+=dt;
      resRipple.setAttribute('r',(62+S.rippleT*140).toFixed(1));
      resRipple.setAttribute('stroke',`rgba(180,225,255,${Math.max(0,.95-S.rippleT*1.1).toFixed(2)})`);
      resRipple.setAttribute('stroke-width','4.5');
      if(S.rippleT>.9) S.rippleT=-1;
    }
    if(S.rip2T>=0){
      S.rip2T+=dt;
      resRip2.setAttribute('r',(62+S.rip2T*110).toFixed(1));
      resRip2.setAttribute('stroke',`rgba(255,255,255,${Math.max(0,.72-S.rip2T*1.0).toFixed(2)})`);
      resRip2.setAttribute('stroke-width','2.5');
      if(S.rip2T>.8) S.rip2T=-1;
    }
  }

  /* ━━ P4 BLOOM ━━ */
  else if(S.phase===4){
    const p=S.energy;
    const bloomH=p<.5?p*.04:0.04+(p-.5)*.12;
    const bloomL=.14+p*.64;
    coreMat.color.setHSL(bloomH,.95,bloomL);
    coreMat.emissive.setHSL(bloomH,.98,.04+p*.48);
    // holdArc lerpぬるぬる充填
    const arcTarget=541*(1-p);
    S.arcOffset=lerp(S.arcOffset,arcTarget,.12);
    holdArc.setAttribute('stroke-dashoffset',S.arcOffset.toFixed(1));
    const arcH=Math.round(bloomH*360),arcL=Math.round(48+p*44);
    holdArc.setAttribute('stroke',`hsl(${arcH},100%,${arcL}%)`);
    if(p>.85) holdArc.style.filter=`drop-shadow(0 0 ${Math.round(6+p*12)}px hsl(${arcH},100%,${arcL}%))`;
    else holdArc.style.filter='';
    if(S.holding){
      S.energy=Math.min(1,S.energy+.005);
      holdArc.style.opacity='1';
      LT.pLIntensity=2+p*18;
      if(p>.82){
        LT.haloOp=clamp((p-.82)*6,0,1);LT.haloScale=1+p*.8;
        LT.edgeGlow=p*110;S.shakeAmt=p>.92?(p-.92)*3:0;
        const br=Math.round(26+p*16),bg2=Math.round(5+p*12);
        document.body.style.background=`radial-gradient(ellipse at 50% 40%,rgb(${br},${bg2},0) 0%,#080100 60%,#010100 100%)`;
      } else {LT.haloOp=0;LT.haloScale=1;LT.edgeGlow=0;}
    } else {
      holdArc.style.opacity=String((.5+Math.sin(t*2.2)*.35).toFixed(2));
      holdArc.style.filter='';
      LT.pLIntensity=1.5;
    }
    const bpm=55+p*80;const tp=(t*bpm/60)%1;
    const beat=tp<.18?Math.sin((tp/.18)*Math.PI):0;
    LT.coreScale=1+beat*p*.22;
    coreObj.rotation.y=t*.20+S.rot;
    pPM.opacity=p*.72;pPM.color.setHSL(bloomH,1,.82);
    for(let i=0;i<PC;i++){
      pPA[i*3]*=.93;pPA[i*3+1]*=.93;pPA[i*3+2]*=.93;
      if(Math.abs(pPA[i*3])<.2){pPA[i*3]=rnd(-9,9);pPA[i*3+1]=rnd(-9,9);pPA[i*3+2]=rnd(-9,9);}
    }
    pPG.attributes.position.needsUpdate=true;
  }

  /* ━━ P5 SCATTER ━━ */
  else if(S.phase===5){
    const el5=t-S.p5Start;
    if(el5<2.5){renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=Math.max(1,5-el5*2);}
    else renderer.toneMapping=THREE.NoToneMapping;
    if(el5<1.6&&coreObj&&coreObj.visible){
      coreObj.scale.setScalar(1+el5*1.3);coreObj.rotation.y+=dt*4.5;coreObj.rotation.x+=dt*2.2;
      coreMat.opacity=Math.max(0,1-el5*.6);if(el5>.18) coreMat.transparent=true;
    }
    if(el5>=.4){
      if(coreObj&&coreObj.visible&&el5>1.5) coreObj.visible=false;
      const fe=el5-.4;
      fragmentMeshes.forEach((m,idx)=>{
        m.position.addScaledVector(m.userData.vel,1);
        m.userData.vel.multiplyScalar(.97); // 空気抵抗
        m.userData.vel.y-=.0025;
        m.rotation.x+=m.userData.angVel.x;m.rotation.y+=m.userData.angVel.y;m.rotation.z+=m.userData.angVel.z;
        m.material.opacity=Math.max(0,1-fe*.26);
        m.material.emissive.setHSL((S.hue+idx*.025+fe*.18)%1,1,.28+fe*.22);
      });
    }
    let upd=false;
    for(let i=0;i<shardInfo.length;i++){
      const p2=shardInfo[i];const el=el5-p2.delay;if(el<0)continue;
      const tt=clamp(el/.36,0,1),te=EQ(tt);
      p2.d.position.lerpVectors(p2.sp,p2.fp,te);
      p2.d.quaternion.setFromRotationMatrix(p2.mat);p2.d.scale.setFromMatrixScale(p2.mat);p2.d.updateMatrix();
      shards.setMatrixAt(i,p2.d.matrix);upd=true;
      if(tt>=1&&!p2.landed){
        p2.landed=true;LT.pLIntensity=Math.max(LC.pLIntensity,4);
        for(let k=0;k<6;k++){
          const si=Math.floor(rnd(0,PC))*3;
          pPA[si]=p2.fp.x+rnd(-.5,.5);pPA[si+1]=p2.fp.y+rnd(-.5,.5);pPA[si+2]=p2.fp.z+rnd(-.5,.5);
          pPV[si/3].set(rnd(-.06,.06),rnd(0,.06),rnd(-.06,.06));
        }
        pPG.attributes.position.needsUpdate=true;pPM.opacity=Math.max(pPM.opacity,.5);
        pPM.color.setHSL((S.petalHue+rnd(0,.3))%1,1,.82);
      }
    }
    if(upd) shards.instanceMatrix.needsUpdate=true;
    shards.position.y=Math.sin(t*.8)*.28;shards.rotation.y=t*.032;
    LT.camZ=Math.min(22,S.p5CamStart+el5*3.2);
    if(pPM.opacity>0){
      pPM.opacity=Math.max(0,pPM.opacity-.002);
      for(let i=0;i<PC;i++){pPA[i*3]+=pPV[i].x;pPA[i*3+1]+=pPV[i].y;pPA[i*3+2]+=pPV[i].z;}
      pPG.attributes.position.needsUpdate=true;
    }
  }

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

